### Репликация и удаление

#### конфигурация тестового стенда
3 одинаковых ноды `click-0{1,2,3}.lan`:
```
click-01:~$ cat /etc/os-release
PRETTY_NAME="Ubuntu 24.04.3 LTS"

click-01:~$ clickhouse-server --version
ClickHouse server version 25.7.5.34 (official build).
```

#### конфигурация clickhouse
```bash
sudo cat /etc/clickhouse-server/config.d/keeper.xml
```
```xml
<clickhouse>
    <keeper_server>
        <tcp_port>2181</tcp_port>
        <server_id>1</server_id>
        <log_storage_path>/var/lib/clickhouse/coordination/log</log_storage_path>
        <snapshot_storage_path>/var/lib/clickhouse/coordination/snapshots</snapshot_storage_path>

        <coordination_settings>
            <operation_timeout_ms>10000</operation_timeout_ms>
            <session_timeout_ms>30000</session_timeout_ms>
            <raft_logs_level>trace</raft_logs_level>
        </coordination_settings>

        <raft_configuration>
            <server>
                <id>1</id>
                <hostname>click-01.lan</hostname>
                <port>9234</port>
            </server>
            <server>
                <id>2</id>
                <hostname>click-02.lan</hostname>
                <port>9234</port>
            </server>
            <server>
                <id>3</id>
                <hostname>click-03.lan</hostname>
                <port>9234</port>
            </server>
        </raft_configuration>
    </keeper_server>
</clickhouse>
```
```bash
sudo cat /etc/clickhouse-server/config.d/remote_servers.xml
```
```xml
<clickhouse>
    <remote_servers>
        <cluster_01>
            <shard>
                <replica>
                    <host>click-01.lan</host>
                    <port>9000</port>
                    <user>replicator</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-02.lan</host>
                    <port>9000</port>
                    <user>replicator</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-03.lan</host>
                    <port>9000</port>
                    <user>replicator</user>
                    <password>0000</password>
                </replica>
            </shard>
        </cluster_01>
    </remote_servers>
</clickhouse>
```
```bash
sudo cat /etc/clickhouse-server/config.d/macros.xml
```
```xml
<clickhouse>
    <macros>
        <node>1</node>
    </macros>
</clickhouse>
```

#### создание демонстрационного DATASET
```sql
CREATE DATABASE uk;

CREATE TABLE uk.uk_price_paid
(
    price UInt32,
    date Date,
    postcode1 LowCardinality(String),
    postcode2 LowCardinality(String),
    type Enum8('terraced' = 1, 'semi-detached' = 2, 'detached' = 3, 'flat' = 4, 'other' = 0),
    is_new UInt8,
    duration Enum8('freehold' = 1, 'leasehold' = 2, 'unknown' = 0),
    addr1 String,
    addr2 String,
    street LowCardinality(String),
    locality LowCardinality(String),
    town LowCardinality(String),
    district LowCardinality(String),
    county LowCardinality(String)
)
ENGINE = MergeTree
ORDER BY (postcode1, postcode2, addr1, addr2);

INSERT INTO uk.uk_price_paid
SELECT
    toUInt32(price_string) AS price,
    parseDateTimeBestEffortUS(time) AS date,
    splitByChar(' ', postcode)[1] AS postcode1,
    splitByChar(' ', postcode)[2] AS postcode2,
    transform(a, ['T', 'S', 'D', 'F', 'O'], ['terraced', 'semi-detached', 'detached', 'flat', 'other']) AS type,
    b = 'Y' AS is_new,
    transform(c, ['F', 'L', 'U'], ['freehold', 'leasehold', 'unknown']) AS duration,
    addr1,
    addr2,
    street,
    locality,
    town,
    district,
    county
FROM url(
    'http://prod1.publicdata.landregistry.gov.uk.s3-website-eu-west-1.amazonaws.com/pp-complete.csv',
    'CSV',
    'uuid_string String,
    price_string String,
    time String,
    postcode String,
    a String,
    b String,
    c String,
    addr1 String,
    addr2 String,
    street String,
    locality String,
    town String,
    district String,
    county String,
    d String,
    e String'
) SETTINGS max_http_get_redirects=10;
```

#### Конвертируйте таблицу в реплицируемую, используя макрос replica
##### создание реплицируемой таблицы
```
click-01.lan :) CREATE TABLE uk.uk_price_paid_replicated ON CLUSTER cluster_01 AS uk.uk_price_paid
ENGINE = ReplicatedMergeTree('/clickhouse/{database}/{table}', '{node}')

Query id: 0cec1500-9bd3-4c37-8e82-ccdc1e9d9893

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-01.lan │ 9000 │      0 │       │                   2 │                0 │
2. │ click-03.lan │ 9000 │      0 │       │                   1 │                0 │
3. │ click-02.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

3 rows in set. Elapsed: 1.529 sec.
```
##### перенос данных в реплицируемую таблицу
```
click-01.lan :) SELECT partition_id
FROM system.parts
WHERE (database = 'uk') AND (`table` = 'uk_price_paid')

Query id: a4a98c22-7c8b-4ff5-a7fb-e62098cfe9e1

   ┌─partition_id─┐
1. │ all          │
   └──────────────┘

1 row in set. Elapsed: 0.012 sec.

click-01.lan :) ALTER TABLE uk.uk_price_paid_replicated ATTACH PARTITION ID 'all' FROM uk.uk_price_paid;

Query id: 2b3bd936-0800-433c-bff0-afb7e3bb1163

Ok.

0 rows in set. Elapsed: 0.008 sec.
```
##### проверка наличия данных на остальных нодах
```
click-02.lan :) SELECT count() FROM uk.uk_price_paid_replicated;

Query id: 32101eec-886b-4971-9959-439614dafbcf

   ┌──count()─┐
1. │ 30452463 │ -- 30.45 million
   └──────────┘

1 row in set. Elapsed: 0.004 sec.

click-03.lan :) SELECT count() FROM uk.uk_price_paid_replicated;

Query id: e6e8a722-95cf-4dd7-9fbb-c476476ab095

   ┌──count()─┐
1. │ 30452463 │ -- 30.45 million
   └──────────┘

1 row in set. Elapsed: 0.003 sec.
```

##### удаление старой таблицы
```
DROP TABLE uk.uk_price_paid;
```

#### Выполните запросы и отдайте результаты как 2 файла
```
click-01.lan :)
SELECT
    getMacro('node'),
    *
FROM remote('click-01.lan,click-02.lan,click-03.lan', system.parts, 'default', '0000')
INTO OUTFILE 'system.parts.json'
FORMAT JSONEachRow

Query id: 62e3f621-2240-4e39-a8d3-3ca11d31dce4

762 rows in set. Elapsed: 0.118 sec.

click-01.lan :)
SELECT *
FROM system.replicas
INTO OUTFILE 'system.replicas.json'
FORMAT JSONEachRow

Query id: c48e14cb-1cb1-463e-aa1c-03ee3579425e

1 row in set. Elapsed: 0.037 sec.
```

#### Добавьте или выберите колонку с типом Date в таблице, добавьте TTL на таблицу «хранить последние 7 дней»
```
click-01.lan :) ALTER TABLE uk.uk_price_paid_replicated MODIFY TTL date + INTERVAL 7 DAY;

ALTER TABLE uk.uk_price_paid_replicated
    (MODIFY TTL date + toIntervalDay(7))

Query id: cdff9df5-8379-48c6-b27f-3443b687664b


Elapsed: 0.428 sec.
```

#### результат запроса SHOW CREATE TABLE
```
click-01.lan :) SHOW CREATE TABLE uk.uk_price_paid_replicated

SHOW CREATE TABLE uk.uk_price_paid_replicated

Query id: 758c2dfe-7909-4570-b438-270cc5aa6b81

   ┌─statement───────────────────────────────────────────────────────────────────────────────────────┐
1. │ CREATE TABLE uk.uk_price_paid_replicated                                                       ↴│
   │↳(                                                                                              ↴│
   │↳    `price` UInt32,                                                                            ↴│
   │↳    `date` Date,                                                                               ↴│
   │↳    `postcode1` LowCardinality(String),                                                        ↴│
   │↳    `postcode2` LowCardinality(String),                                                        ↴│
   │↳    `type` Enum8('other' = 0, 'terraced' = 1, 'semi-detached' = 2, 'detached' = 3, 'flat' = 4),↴│
   │↳    `is_new` UInt8,                                                                            ↴│
   │↳    `duration` Enum8('unknown' = 0, 'freehold' = 1, 'leasehold' = 2),                          ↴│
   │↳    `addr1` String,                                                                            ↴│
   │↳    `addr2` String,                                                                            ↴│
   │↳    `street` LowCardinality(String),                                                           ↴│
   │↳    `locality` LowCardinality(String),                                                         ↴│
   │↳    `town` LowCardinality(String),                                                             ↴│
   │↳    `district` LowCardinality(String),                                                         ↴│
   │↳    `county` LowCardinality(String)                                                            ↴│
   │↳)                                                                                              ↴│
   │↳ENGINE = ReplicatedMergeTree('/clickhouse/uk/uk_price_paid_replicated', '{node}')              ↴│
   │↳ORDER BY (postcode1, postcode2, addr1, addr2)                                                  ↴│
   │↳TTL date + toIntervalDay(7)                                                                    ↴│
   │↳SETTINGS index_granularity = 8192                                                               │
   └─────────────────────────────────────────────────────────────────────────────────────────────────┘

1 row in set. Elapsed: 0.004 sec.
```
