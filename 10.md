## Шардирование

### конфигурация тестового стенда
4 одинаковых ноды `click-0{1,2,3,4}.lan`:
```
click-01:~$ cat /etc/os-release
PRETTY_NAME="Ubuntu 24.04.3 LTS"

click-01:~$ clickhouse-server --version
ClickHouse server version 25.7.5.34 (official build).
```

### конфигурация clickhouse
в конфигурации описано 3 топологии, исходя из 4 нод:
1. 2 шарда, 2 реплики каждого шарда (фактор репликации - 2)
2. 4 шарда (фактор репликации - 1)
3. 4 реплики (фактор репликации - 4)

```bash
sudo cat /etc/clickhouse-server/config.d/remote_servers.xml
```
```xml
<clickhouse>
    <remote_servers>
        <cluster_2S_2R>
            <shard>
                <replica>
                    <host>click-01.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-03.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
            <shard>
                <replica>
                    <host>click-02.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-04.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
        </cluster_2S_2R>
        <cluster_4S>
            <shard>
                <replica>
                    <host>click-01.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
            <shard>
                <replica>
                    <host>click-02.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
            <shard>
                <replica>
                    <host>click-03.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
            <shard>
                <replica>
                    <host>click-04.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
        </cluster_4S>
        <cluster_4R>
            <shard>
                <replica>
                    <host>click-01.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-02.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-03.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
                <replica>
                    <host>click-04.lan</host>
                    <port>9000</port>
                    <user>default</user>
                    <password>0000</password>
                </replica>
            </shard>
        </cluster_4R>
    </remote_servers>
</clickhouse>
```
#### макросы на каждой ноде со своим номером
```bash
sudo cat /etc/clickhouse-server/config.d/macros.xml
```
click-01:
```xml
<clickhouse>
    <macros>
        <shard_2s2r>1</shard_2s2r>
        <replica_2s2r>1</replica_2s2r>

        <shard_4s>1</shard_4s>
        <replica_4s>1</replica_4s>

        <shard_4r>1</shard_4r>
        <replica_4r>1</replica_4r>
    </macros>
</clickhouse>
```
click-02:
```xml
<clickhouse>
    <macros>
        <shard_2s2r>2</shard_2s2r>
        <replica_2s2r>1</replica_2s2r>

        <shard_4s>2</shard_4s>
        <replica_4s>1</replica_4s>

        <shard_4r>1</shard_4r>
        <replica_4r>2</replica_4r>
    </macros>
</clickhouse>
```
click-03:
```xml
<clickhouse>
    <macros>
        <shard_2s2r>1</shard_2s2r>
        <replica_2s2r>2</replica_2s2r>

        <shard_4s>3</shard_4s>
        <replica_4s>1</replica_4s>

        <shard_4r>1</shard_4r>
        <replica_4r>3</replica_4r>
    </macros>
</clickhouse>
```
click-04:
```xml
<clickhouse>
    <macros>
        <shard_2s2r>2</shard_2s2r>
        <replica_2s2r>2</replica_2s2r>

        <shard_4s>4</shard_4s>
        <replica_4s>1</replica_4s>

        <shard_4r>1</shard_4r>
        <replica_4r>4</replica_4r>
    </macros>
</clickhouse>
```
конфигурация DCS:
```bash
sudo cat /etc/clickhouse-server/config.d/keeper.xml
```
```xml
<clickhouse>
    <keeper_server>
        <tcp_port>2181</tcp_port>
        <server_id>1</server_id>
        <log_storage_path>/var/lib/clickhouse/coordination/log</log_storage_path>
        <snapshot_storage_path>/var/lib/clickhouse/coordination/snapshots</snapshot_storage_path>

        <coordination_settings>
            <operation_timeout_ms>10000</operation_timeout_ms>
            <session_timeout_ms>30000</session_timeout_ms>
            <raft_logs_level>trace</raft_logs_level>
        </coordination_settings>

        <raft_configuration>
            <server>
                <id>1</id>
                <hostname>click-01.lan</hostname>
                <port>9234</port>
            </server>
            <server>
                <id>2</id>
                <hostname>click-02.lan</hostname>
                <port>9234</port>
            </server>
            <server>
                <id>3</id>
                <hostname>click-03.lan</hostname>
                <port>9234</port>
            </server>
            <server>
                <id>4</id>
                <hostname>click-04.lan</hostname>
                <port>9234</port>
            </server>
        </raft_configuration>
    </keeper_server>
</clickhouse>
```

### создание таблицы
#### 1. реплицируемая таблица
```sql
click-01.lan :) 
CREATE TABLE default.messages_4r ON CLUSTER cluster_4R
(
    `user_id` UInt16,
    `body` String,
    `ts` DateTime DEFAULT now()
)
ENGINE = ReplicatedMergeTree('/clickhouse/{database}/{table}/{shard_4r}', '{replica_4r}')
ORDER BY user_id

Query id: 64ed40b0-26c3-45d5-af16-affd24abfa26

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-03.lan │ 9000 │      0 │       │                   3 │                2 │
2. │ click-04.lan │ 9000 │      0 │       │                   2 │                0 │
3. │ click-01.lan │ 9000 │      0 │       │                   1 │                0 │
4. │ click-02.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 2.012 sec.
```
```sql
click-01.lan :) INSERT INTO default.messages_4r
    (user_id, body)
VALUES
    (1, 'ping'), (2, 'pong'), (3, 'lorem ipsum'), (4, 'click-clack');

Query id: 7782918c-e224-4154-a89a-fb3bb0d133bd

Ok.

4 rows in set. Elapsed: 0.404 sec.
```
```sql
click-01.lan :)
SELECT
    getMacro('replica_4r'),
    count(*)
FROM remote('click-01.lan,click-02.lan,click-03.lan,click-04.lan', default.messages_4r, 'default', '0000')
GROUP BY 1

Query id: 9245cb9a-3017-4298-b24c-c31a6fcd0804

   ┌─getMacro('replica_4r')─┬─count()─┐
1. │ 3                      │       4 │
2. │ 2                      │       4 │
3. │ 4                      │       4 │
4. │ 1                      │       4 │
   └────────────────────────┴─────────┘

4 rows in set. Elapsed: 0.096 sec.
```
все строки отреплицировались на все реплики

#### 2. создание распределённой таблицы в кластере 2S_2R
```sql
click-01.lan :) 
CREATE TABLE default.messages ON CLUSTER cluster_2S_2R
(
    `user_id` UInt16,
    `body` String,
    `ts` DateTime DEFAULT now()
)
ENGINE = MergeTree
ORDER BY user_id

Query id: 416c88af-8768-4db1-9f9a-286b3696441b

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-01.lan │ 9000 │      0 │       │                   3 │                0 │
2. │ click-02.lan │ 9000 │      0 │       │                   2 │                0 │
3. │ click-04.lan │ 9000 │      0 │       │                   1 │                0 │
4. │ click-03.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.365 sec
```
```sql
CREATE TABLE messages_2s2r
ON CLUSTER cluster_2S_2R
AS messages
ENGINE = Distributed('cluster_2S_2R', 'default', 'messages', user_id % 2);

Query id: a2ad2745-e835-47d2-b527-b17cde4ef93f

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-02.lan │ 9000 │      0 │       │                   3 │                1 │
2. │ click-03.lan │ 9000 │      0 │       │                   2 │                1 │
3. │ click-01.lan │ 9000 │      0 │       │                   1 │                0 │
4. │ click-04.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.415 sec.
```
```sql
click-01.lan :) INSERT INTO default.messages_2s2r
    (user_id, body)
VALUES
    (1, 'ping'), (2, 'pong'), (3, 'lorem ipsum'), (4, 'click-clack');

Query id: ef2aa629-e083-48c8-b63f-b59fae04c0c2

Ok.

4 rows in set. Elapsed: 0.022 sec.
```
```sql
click-01.lan :) SELECT *,hostName(),_shard_num from messages_2s2r

Query id: fe293212-6b62-40d3-95e2-efdefbd570a4

   ┌─user_id─┬─body────────┬──────────────────ts─┬─hostName()─┬─_shard_num─┐
1. │       2 │ pong        │ 2025-09-24 14:13:49 │ click-01   │          1 │
2. │       4 │ click-clack │ 2025-09-24 14:13:49 │ click-01   │          1 │
3. │       1 │ ping        │ 2025-09-24 14:13:49 │ click-04   │          2 │
4. │       3 │ lorem ipsum │ 2025-09-24 14:13:49 │ click-04   │          2 │
   └─────────┴─────────────┴─────────────────────┴────────────┴────────────┘

4 rows in set. Elapsed: 0.055 sec.
```
данные распределились равномерно по шардам по остатку от деления user_id на 2

#### 3. создание распределённой таблицы в кластере 4S
```sql
click-01.lan :) CREATE TABLE default.messages ON CLUSTER cluster_4S
(
    `user_id` UInt16,
    `body` String,
    `ts` DateTime DEFAULT now()
)
ENGINE = MergeTree
ORDER BY user_id

Query id: 8f2ec13b-0ad8-4c9e-aa68-8c3945933a30

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-01.lan │ 9000 │      0 │       │                   3 │                0 │
2. │ click-02.lan │ 9000 │      0 │       │                   2 │                0 │
3. │ click-04.lan │ 9000 │      0 │       │                   1 │                0 │
4. │ click-03.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.445 sec.
```
```sql
click-01.lan :) CREATE TABLE messages_4s ON CLUSTER cluster_4S AS messages
ENGINE = Distributed('cluster_4S', 'default', 'messages', rand())

Query id: 6808430b-e7ed-4575-95bd-6400ba6ced1c

   ┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐
1. │ click-04.lan │ 9000 │      0 │       │                   3 │                2 │
2. │ click-03.lan │ 9000 │      0 │       │                   2 │                2 │
3. │ click-02.lan │ 9000 │      0 │       │                   1 │                0 │
4. │ click-01.lan │ 9000 │      0 │       │                   0 │                0 │
   └──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘

4 rows in set. Elapsed: 0.230 sec.
```
```sql
click-01.lan :) INSERT INTO default.messages_4s
    (user_id, body)
VALUES
    (1, 'ping'), (2, 'pong'), (3, 'lorem ipsum'), (4, 'click-clack'), (5, 'rock-chop');

Query id: c737633b-8ae0-45e8-8361-30203cd738cb

Ok.

4 rows in set. Elapsed: 0.026 sec.
```
```sql
click-01.lan :) SELECT *, hostName(), _shard_num from messages_4s

Query id: 950ff7a9-0b78-4bad-a3f0-43732c58be20

   ┌─user_id─┬─body────────┬──────────────────ts─┬─hostName()─┬─_shard_num─┐
1. │       1 │ ping        │ 2025-09-24 14:25:20 │ click-01   │          1 │
2. │       5 │ rock-chop   │ 2025-09-24 14:25:20 │ click-01   │          1 │
3. │       3 │ lorem ipsum │ 2025-09-24 14:25:20 │ click-02   │          2 │
4. │       4 │ click-clack │ 2025-09-24 14:25:20 │ click-02   │          2 │
5. │       2 │ pong        │ 2025-09-24 14:25:20 │ click-04   │          4 │
   └─────────┴─────────────┴─────────────────────┴────────────┴────────────┘

5 rows in set. Elapsed: 0.107 sec.
```
данные распределились по шардам в случайном порядке
